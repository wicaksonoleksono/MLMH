{% extends "base.html" %} {% block title %}Assessment Dashboard{% endblock %} {%
block content %}
<div class="min-h-screen bg-gray-50">
  <!-- Simple Navigation -->
  <nav class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-xl font-semibold text-gray-900">Assessment Dashboard</h1>
      <a
        href="{{ url_for('auth.logout') }}"
        class="text-gray-500 hover:text-red-600 font-medium transition-colors"
      >
        Keluar
      </a>
    </div>
  </nav>

  <div
    class="max-w-4xl mx-auto px-4 py-8 space-y-6"
    x-data="assessmentDashboard()"
  >
    <!-- Progress Steps -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">
        Progress Assessment
      </h2>
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <div
            class="w-10 h-10 {% if not session.consent_completed_at %}bg-blue-600 text-white{% else %}bg-green-600 text-white{% endif %} rounded-full flex items-center justify-center text-sm font-medium"
          >
            1
          </div>
          <span
            class="ml-3 text-sm font-medium {% if not session.consent_completed_at %}text-blue-600{% else %}text-green-600{% endif %}"
            >Informed Consent</span
          >
        </div>
        <div
          class="flex-1 h-2 {% if session.consent_completed_at %}bg-green-200{% else %}bg-gray-200{% endif %} mx-4 rounded"
        ></div>
        <div class="flex items-center">
          {% set camera_completed = session.session_metadata and
          session.session_metadata.get('camera_completed_at') %}
          <div
            class="w-10 h-10 {% if session.consent_completed_at and not camera_completed %}bg-blue-600 text-white{% elif camera_completed %}bg-green-600 text-white{% else %}bg-gray-300 text-gray-600{% endif %} rounded-full flex items-center justify-center text-sm font-medium"
          >
            2
          </div>
          <span
            class="ml-3 text-sm font-medium {% if session.consent_completed_at and not camera_completed %}text-blue-600{% elif camera_completed %}text-green-600{% else %}text-gray-500{% endif %}"
            >Camera Check</span
          >
        </div>
        <div
          class="flex-1 h-2 {% if camera_completed %}bg-green-200{% else %}bg-gray-200{% endif %} mx-4 rounded"
        ></div>
        <div class="flex items-center">
          {% set assessment_in_progress = session.status in ['PHQ_IN_PROGRESS',
          'LLM_IN_PROGRESS'] %} {% set assessment_completed = session.status ==
          'COMPLETED' %}
          <div
            class="w-10 h-10 {% if assessment_completed %}bg-green-600 text-white{% elif assessment_in_progress %}bg-blue-600 text-white{% elif camera_completed %}bg-yellow-500 text-white{% else %}bg-gray-300 text-gray-600{% endif %} rounded-full flex items-center justify-center text-sm font-medium"
          >
            3
          </div>
          <span
            class="ml-3 text-sm font-medium {% if assessment_completed %}text-green-600{% elif assessment_in_progress %}text-blue-600{% elif camera_completed %}text-yellow-600{% else %}text-gray-500{% endif %}"
            >Assessment</span
          >
        </div>
      </div>
    </div>

    <!-- Current Step Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
      {% if not session.consent_completed_at %}
      <!-- Consent Step -->
      <div class="text-center">
        <div class="text-6xl mb-4">üìã</div>
        <h2 class="text-2xl font-bold text-gray-900 mb-3">Informed Consent</h2>
        <p class="text-gray-600 mb-6">
          Silakan baca dan setujui formulir persetujuan untuk melanjutkan
          assessment
        </p>
        <button
          @click="goToConsent()"
          class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-8 rounded-xl transition-colors"
        >
          Baca Formulir Persetujuan
        </button>
      </div>
      {% elif session.status == 'COMPLETED' %}
      <!-- Assessment Complete -->
      <div class="text-center">
        <div class="text-6xl mb-4">‚úÖ</div>
        <h2 class="text-2xl font-bold text-gray-900 mb-3">
          Assessment Selesai
        </h2>
        <p class="text-gray-600 mb-6">
          Terima kasih! Assessment Anda telah selesai.
        </p>
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <h3 class="font-semibold text-gray-900 mb-2">Ringkasan Session:</h3>
          <div class="text-sm text-gray-600 space-y-1">
            <p>
              PHQ selesai: {{ session.phq_completed_at.strftime('%d/%m/%Y
              %H:%M') if session.phq_completed_at else '-' }}
            </p>
            <p>
              Open Question selesai: {{ session.llm_completed_at.strftime('%d/%m/%Y
              %H:%M') if session.llm_completed_at else '-' }}
            </p>
            <p>
              Durasi total: {{ session.duration_seconds // 60 if
              session.duration_seconds else '-' }} menit
            </p>
          </div>
        </div>
      </div>
      {% elif session.status == 'CAMERA_CHECK' %}
      <!-- Ready for Assessment -->
      <div class="text-center">
        <div class="text-6xl mb-4">üìù</div>
        <h2 class="text-2xl font-bold text-gray-900 mb-3">Mulai Assessment</h2>
        <p class="text-gray-600 mb-6">
          Semua persiapan selesai. Assessment akan dimulai dengan {% if session.is_first == 'llm' %}Open Question{% else %}{{ session.is_first.upper() }}{% endif %} terlebih dahulu.
        </p>
        <button
          @click="startFirstAssessment()"
          class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-8 rounded-xl transition-colors mr-4"
        >
          Mulai {% if session.is_first == 'llm' %}Open Question{% else %}{{ session.is_first.upper() }}{% endif %} Assessment
        </button>
        <button
          @click="resetSession()"
          class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-8 rounded-xl transition-colors mt-4"
        >
          Reset Session dan Mulai dari Awal
        </button>
      </div>

      {% else %}
      <!-- Redirecting to Assessment -->
      <div class="text-center">
        <div class="text-6xl mb-4">üîÑ</div>
        <h2 class="text-2xl font-bold text-gray-900 mb-3">
          Mengarahkan ke Assessment
        </h2>
        <p class="text-gray-600 mb-6">
          Sistem sedang mengarahkan Anda ke assessment berikutnya...
        </p>
        <div
          class="animate-spin rounded-full h-8 w-8 border-4 border-gray-200 border-t-purple-600 mx-auto"
        ></div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  // Direct refresh detection - redirect with reset parameter
  window.addEventListener('beforeunload', function() {
    // Only set the flag if there's an active session
    const sessionId = "{{ session.id }}";
    if (sessionId) {
      // Set a flag in sessionStorage (cleared on tab close)
      sessionStorage.setItem('refreshingSession', sessionId);
    }
  });

  function assessmentDashboard() {
      return {
          sessionId: "{{ session.id }}",
          sessionType: '{{ session.is_first }}',

          async init() {
              // Check if we're coming from a refresh
              await this.handleRefreshRedirect();
          },

          async handleRefreshRedirect() {
              // Check if we're coming from a refresh
              const refreshingSession = sessionStorage.getItem('refreshingSession');
              if (refreshingSession === this.sessionId) {
                  sessionStorage.removeItem('refreshingSession');
                  // Redirect to dashboard with reset parameter
                  window.location.href = `/assessment/?reset_session=${this.sessionId}`;
              }
          },

          async resetSession() {
              if (confirm('Apakah Anda yakin ingin mereset session assessment ini dan memulai dari awal? Semua data yang belum disimpan akan hilang.')) {
                  try {
                      await this.performReset();
                  } catch (error) {
                      alert('Gagal mereset session: ' + error.message);
                  }
              }
          },

          async performReset() {
              const response = await fetch(`/assessment/reset-session-on-refresh/${this.sessionId}`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  }
              });
              
              // Redirect to main menu
              window.location.href = '/';
          },

          goToConsent() {
              window.location.href = '/assessment/consent';
          },

          startFirstAssessment() {
              if (this.sessionType === 'phq') {
                  window.location.href = '/assessment/phq';
              } else if (this.sessionType === 'llm') {
                  window.location.href = '/assessment/llm';
              }
          }
      };
  }
  // Initialize refresh detection for this session
  setupRefreshDetection("{{ session.id }}");
</script>
<script src="{{ url_for('static', filename='js/refreshDetection.js') }}"></script>
{% endblock %}
