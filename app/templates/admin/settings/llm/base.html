{% extends "admin/base.html" %} {% block title %}Pengaturan LLM - Admin{%
endblock %} {% block content %}
<div class="min-h-screen bg-gray-50" x-data="llmSettings()">
  <!-- Header -->
  <div class="bg-white border-b border-gray-200 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">
            Pengaturan LLM & AI Model
          </h1>
          <p class="text-gray-600 mt-1">
            Konfigurasi model AI dan aspek analisis depresi untuk assessment
          </p>
        </div>
        <div class="flex space-x-3">
          <button
            @click="loadDefaults()"
            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
          >
            Muat Default
          </button>
          <button
            @click="clearAll()"
            class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors"
          >
            Hapus Semua
          </button>
          <button
            @click="saveAll()"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
          >
            Simpan Semua
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-6 py-6 space-y-6">
    {% block llm_content %}{% endblock %}
  </div>

  {% include "components/modal.html" %}
  {% include "components/preview_modal.html" %}

  <!-- Loading -->
  <div
    x-show="loading"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  >
    <div class="bg-white rounded-lg p-8 shadow-xl">
      <div class="text-center">
        <div
          class="animate-spin rounded-full h-12 w-12 border-4 border-gray-200 border-t-blue-600 mx-auto mb-4"
        ></div>
        <p class="text-gray-600 text-lg">Menyimpan data...</p>
      </div>
    </div>
  </div>
</div>

<script>
  function llmSettings() {
    return {
      loading: false,

      settings: {
        instructions: "",
        llm_instructions: "",
        openai_api_key: "",
        chat_model: "gpt-4o",
        analysis_model: "gpt-4o-mini",
        depression_aspects: [
          { name: "Anhedonia", description: "kehilangan minat/kenikmatan" },
          {
            name: "Bias kognitif negatif",
            description: "hopelessness & negative thinking patterns",
          },
          { name: "Rumination", description: "pikiran berputar tanpa solusi" },
          {
            name: "Psikomotor retardation",
            description: "perlambatan gerakan dan bicara",
          },
          {
            name: "Gangguan tidur",
            description: "insomnia, kualitas tidur jelek",
          },
          {
            name: "Iritabilitas",
            description: "ledakan marah & mudah tersinggung",
          },
          {
            name: "Rasa bersalah berlebih",
            description: "self-blame & worthlessness",
          },
          {
            name: "Gangguan kognitif",
            description: "concentration & executive function issues",
          },
          {
            name: "Penarikan diri sosial",
            description: "isolasi & withdrawal",
          },
          {
            name: "Alexithymia",
            description: "sulit mengenali & mengungkap emosi",
          },
          {
            name: "Defisit regulasi emosi",
            description: "kesulitan mengatur emosi",
          },
        ],
        analysis_scale: [
          { value: 0, description: "Tidak Ada Indikasi Jelas (Gejala tidak muncul dalam percakapan)" },
          { value: 1, description: "Indikasi Ringan (Gejala tersirat atau disebutkan secara tidak langsung)" },
          { value: 2, description: "Indikasi Sedang (Gejala disebutkan dengan cukup jelas, namun tidak mendominasi)" },
          { value: 3, description: "Indikasi Kuat (Gejala disebutkan secara eksplisit, berulang, dan menjadi keluhan utama)" }
        ]
      },

      analysisScaleMax: 4,

      availableModels: [],

      async init() {
        this.loadDataFromTemplate();
      },

      // Modal state
      showModal: false,
      modalTitle: "",
      modalMessage: "",
      modalConfirm: () => {},

      // Preview Modal state (for system prompt preview)
      showPreviewModal: false,
      previewModalTitle: "",
      previewModalContent: "",

      loadDataFromTemplate() {
        // Load data from Jinja template context (passed via window.llmData)
        const llmData = window.llmData || {};

        try {
          // Load settings
          if (llmData.settings) {
            const setting = llmData.settings;
            this.settings = {
              id: setting.id,
              instructions: setting.instructions || "",
              llm_instructions: setting.llm_instructions || "",
              openai_api_key: setting.openai_api_key || "", // This will be the masked version
              openai_api_key_unmasked: setting.openai_api_key_unmasked || "", // This is the real key
              chat_model: setting.chat_model || "gpt-4o",
              analysis_model: setting.analysis_model || "gpt-4o-mini",
              depression_aspects: setting.depression_aspects || [
                {
                  name: "Anhedonia",
                  description: "kehilangan minat/kenikmatan",
                },
                {
                  name: "Bias kognitif negatif",
                  description: "hopelessness & negative thinking patterns",
                },
                {
                  name: "Rumination",
                  description: "pikiran berputar tanpa solusi",
                },
                {
                  name: "Psikomotor retardation",
                  description: "perlambatan gerakan dan bicara",
                },
                {
                  name: "Gangguan tidur",
                  description: "insomnia, kualitas tidur jelek",
                },
                {
                  name: "Iritabilitas",
                  description: "ledakan marah & mudah tersinggung",
                },
                {
                  name: "Rasa bersalah berlebih",
                  description: "self-blame & worthlessness",
                },
                {
                  name: "Gangguan kognitif",
                  description: "concentration & executive function issues",
                },
                {
                  name: "Penarikan diri sosial",
                  description: "isolasi & withdrawal",
                },
                {
                  name: "Alexithymia",
                  description: "sulit mengenali & mengungkap emosi",
                },
                {
                  name: "Defisit regulasi emosi",
                  description: "kesulitan mengatur emosi",
                },
              ],
              analysis_scale: setting.analysis_scale || [
                { value: 0, description: "Tidak Ada Indikasi Jelas (Gejala tidak muncul dalam percakapan)" },
                { value: 1, description: "Indikasi Ringan (Gejala tersirat atau disebutkan secara tidak langsung)" },
                { value: 2, description: "Indikasi Sedang (Gejala disebutkan dengan cukup jelas, namun tidak mendominasi)" },
                { value: 3, description: "Indikasi Kuat (Gejala disebutkan secara eksplisit, berulang, dan menjadi keluhan utama)" }
              ]
            };
            
            // Set the analysisScaleMax to match the analysis_scale length
            this.analysisScaleMax = this.settings.analysis_scale.length;

            // If we have an unmasked key, use it for the display (but mask it immediately)
            if (this.settings.openai_api_key_unmasked) {
              // Keep the unmasked key in a separate variable but don't display it
              // The display will show the masked version
            }
          }

          // Load available models if provided
          if (llmData.available_models) {
            this.availableModels = [...llmData.available_models];
          }
        } catch (error) {
          console.error("Error loading template data:", error);
        }
      },

      async loadDefaults() {
        this.showModal = true;
        this.modalTitle = "Muat Data Default";
        this.modalMessage =
          "Apakah Anda yakin ingin memuat pengaturan LLM default? Data yang ada akan diganti.";
        this.modalConfirm = async () => {
          try {
            const defaults = await apiCall("/admin/llm/settings/default");
            if (defaults) {
              this.settings = {
                instructions: defaults.instructions || "",
                llm_instructions: defaults.llm_instructions || "",
                openai_api_key: defaults.openai_api_key || "",
                openai_api_key_unmasked: "", // No unmasked key for defaults
                chat_model: defaults.chat_model || "gpt-4o",
                analysis_model: defaults.analysis_model || "gpt-4o-mini",
                depression_aspects: defaults.depression_aspects || [
                  {
                    name: "Anhedonia",
                    description: "kehilangan minat/kenikmatan",
                  },
                  {
                    name: "Bias kognitif negatif",
                    description: "hopelessness & negative thinking patterns",
                  },
                  {
                    name: "Rumination",
                    description: "pikiran berputar tanpa solusi",
                  },
                  {
                    name: "Psikomotor retardation",
                    description: "perlambatan gerakan dan bicara",
                  },
                  {
                    name: "Gangguan tidur",
                    description: "insomnia, kualitas tidur jelek",
                  },
                  {
                    name: "Iritabilitas",
                    description: "ledakan marah & mudah tersinggung",
                  },
                  {
                    name: "Rasa bersalah berlebih",
                    description: "self-blame & worthlessness",
                  },
                  {
                    name: "Gangguan kognitif",
                    description: "concentration & executive function issues",
                  },
                  {
                    name: "Penarikan diri sosial",
                    description: "isolasi & withdrawal",
                  },
                  {
                    name: "Alexithymia",
                    description: "sulit mengenali & mengungkap emosi",
                  },
                  {
                    name: "Defisit regulasi emosi",
                    description: "kesulitan mengatur emosi",
                  },
                ],
                analysis_scale: defaults.analysis_scale || [
                  { value: 0, description: "Tidak Ada Indikasi Jelas (Gejala tidak muncul dalam percakapan)" },
                  { value: 1, description: "Indikasi Ringan (Gejala tersirat atau disebutkan secara tidak langsung)" },
                  { value: 2, description: "Indikasi Sedang (Gejala disebutkan dengan cukup jelas, namun tidak mendominasi)" },
                  { value: 3, description: "Indikasi Kuat (Gejala disebutkan secara eksplisit, berulang, dan menjadi keluhan utama)" }
                ]
              };
            } else {
              this.settings = {
                instructions: "",
                llm_instructions: "",
                openai_api_key: "",
                openai_api_key_unmasked: "", // No unmasked key
                chat_model: "gpt-4o",
                analysis_model: "gpt-4o-mini",
                depression_aspects: [
                  {
                    name: "Anhedonia",
                    description: "kehilangan minat/kenikmatan",
                  },
                  {
                    name: "Bias kognitif negatif",
                    description: "hopelessness & negative thinking patterns",
                  },
                  {
                    name: "Rumination",
                    description: "pikiran berputar tanpa solusi",
                  },
                  {
                    name: "Psikomotor retardation",
                    description: "perlambatan gerakan dan bicara",
                  },
                  {
                    name: "Gangguan tidur",
                    description: "insomnia, kualitas tidur jelek",
                  },
                  {
                    name: "Iritabilitas",
                    description: "ledakan marah & mudah tersinggung",
                  },
                  {
                    name: "Rasa bersalah berlebih",
                    description: "self-blame & worthlessness",
                  },
                  {
                    name: "Gangguan kognitif",
                    description: "concentration & executive function issues",
                  },
                  {
                    name: "Penarikan diri sosial",
                    description: "isolasi & withdrawal",
                  },
                  {
                    name: "Alexithymia",
                    description: "sulit mengenali & mengungkap emosi",
                  },
                  {
                    name: "Defisit regulasi emosi",
                    description: "kesulitan mengatur emosi",
                  },
                ],
                analysis_scale: [
                  { value: 0, description: "Tidak Ada Indikasi Jelas (Gejala tidak muncul dalam percakapan)" },
                  { value: 1, description: "Indikasi Ringan (Gejala tersirat atau disebutkan secara tidak langsung)" },
                  { value: 2, description: "Indikasi Sedang (Gejala disebutkan dengan cukup jelas, namun tidak mendominasi)" },
                  { value: 3, description: "Indikasi Kuat (Gejala disebutkan secara eksplisit, berulang, dan menjadi keluhan utama)" }
                ]
              };
            }
            
            // Set the analysisScaleMax to match the analysis_scale length
            this.analysisScaleMax = this.settings.analysis_scale.length;
          } catch (error) {
            this.settings = {
              instructions: "",
              llm_instructions: "",
              openai_api_key: "",
              openai_api_key_unmasked: "", // No unmasked key
              chat_model: "gpt-4o",
              analysis_model: "gpt-4o-mini",
              depression_aspects: [
                {
                  name: "Anhedonia",
                  description: "kehilangan minat/kenikmatan",
                },
                {
                  name: "Bias kognitif negatif",
                  description: "hopelessness & negative thinking patterns",
                },
                {
                  name: "Rumination",
                  description: "pikiran berputar tanpa solusi",
                },
                {
                  name: "Psikomotor retardation",
                  description: "perlambatan gerakan dan bicara",
                },
                {
                  name: "Gangguan tidur",
                  description: "insomnia, kualitas tidur jelek",
                },
                {
                  name: "Iritabilitas",
                  description: "ledakan marah & mudah tersinggung",
                },
                {
                  name: "Rasa bersalah berlebih",
                  description: "self-blame & worthlessness",
                },
                {
                  name: "Gangguan kognitif",
                  description: "concentration & executive function issues",
                },
                {
                  name: "Penarikan diri sosial",
                  description: "isolasi & withdrawal",
                },
                {
                  name: "Alexithymia",
                  description: "sulit mengenali & mengungkap emosi",
                },
                {
                  name: "Defisit regulasi emosi",
                  description: "kesulitan mengatur emosi",
                },
              ],
              analysis_scale: [
                { value: 0, description: "Tidak Ada Indikasi Jelas (Gejala tidak muncul dalam percakapan)" },
                { value: 1, description: "Indikasi Ringan (Gejala tersirat atau disebutkan secara tidak langsung)" },
                { value: 2, description: "Indikasi Sedang (Gejala disebutkan dengan cukup jelas, namun tidak mendominasi)" },
                { value: 3, description: "Indikasi Kuat (Gejala disebutkan secara eksplisit, berulang, dan menjadi keluhan utama)" }
              ]
            };
            
            // Set the analysisScaleMax to match the analysis_scale length
            this.analysisScaleMax = this.settings.analysis_scale.length;
          }
          this.showModal = false;
        };
      },

      async clearAll() {
        this.showModal = true;
        this.modalTitle = "Hapus Semua Data";
        this.modalMessage =
          "Apakah Anda yakin ingin menghapus semua pengaturan LLM yang ada?";
        this.modalConfirm = async () => {
          this.loading = true;
          try {
            const settings = await apiCall("/admin/llm/settings");

            if (Array.isArray(settings)) {
              for (const setting of settings) {
                await apiCall(`/admin/llm/settings/${setting.id}`, "DELETE");
              }
            }

            // Clear the frontend state completely
            this.settings = {
              id: null,
              instructions: "",
              llm_instructions: "",
              openai_api_key: "",
              openai_api_key_unmasked: "",
              chat_model: "",
              analysis_model: "",
              depression_aspects: [], // Empty array instead of default aspects
            };

            // Clear available models as well
            this.availableModels = [];

            this.showModal = true;
            this.modalTitle = "Berhasil";
            this.modalMessage = "Semua pengaturan LLM berhasil dihapus!";
            this.modalConfirm = () => {
              this.showModal = false;
            };
          } catch (error) {
            this.showModal = true;
            this.modalTitle = "Error";
            this.modalMessage = "Error clearing data: " + error.message;
            this.modalConfirm = () => {
              this.showModal = false;
            };
          } finally {
            this.loading = false;
          }
        };
      },

      async saveAll() {
        this.loading = true;
        try {
          const settingsData = {
            instructions: this.settings.instructions,
            llm_instructions: this.settings.llm_instructions,
            chat_model: this.settings.chat_model,
            analysis_model: this.settings.analysis_model,
          };
          //hahaha gajelas manual lah wireshark minta tolong
          if (
            this.settings.openai_api_key &&
            !this.settings.openai_api_key.includes("•")
          ) {
            // NOT MASKED> XDXD ./.
            settingsData.openai_api_key = this.settings.openai_api_key;
          } else if (this.settings.openai_api_key_unmasked) {
            // Use the unmasked key we stored
            settingsData.openai_api_key = this.settings.openai_api_key_unmasked;
          }

          // Only include depression_aspects if it has valid data (not empty or all empty fields)
          const validAspects = this.settings.depression_aspects.filter(
            (aspect) =>
              aspect.name &&
              aspect.name.trim() &&
              aspect.description &&
              aspect.description.trim()
          );

          if (validAspects.length > 0) {
            settingsData.depression_aspects = validAspects;
          }
          // If no valid aspects, don't include the field at all (null handling)
          
          // Include analysis_scale
          if (this.settings.analysis_scale && this.settings.analysis_scale.length > 0) {
            settingsData.analysis_scale = this.settings.analysis_scale;
          }

          const result = await apiCall(
            "/admin/llm/settings",
            "POST",
            settingsData
          );

          if (result.status === "SNAFU") {
            this.showModal = true;
            this.modalTitle = "Error";
            this.modalMessage =
              "Error saving settings: " +
              (result.error || result.errorMsg || "Unknown error");
            this.modalConfirm = () => {
              this.showModal = false;
            };
            return;
          }

          this.showModal = true;
          this.modalTitle = "Berhasil";
          this.modalMessage = "Pengaturan LLM berhasil disimpan!";
          this.modalConfirm = () => {
            this.showModal = false;
            window.location.reload();
          };
        } catch (error) {
          this.showModal = true;
          this.modalTitle = "Error";
          this.modalMessage = "Error saving data: " + error.message;
          this.modalConfirm = () => {};
        } finally {
          this.loading = false;
        }
      },

      async saveAll() {
        this.loading = true;
        try {
          const settingsData = {
            instructions: this.settings.instructions,
            llm_instructions: this.settings.llm_instructions,
            chat_model: this.settings.chat_model,
            analysis_model: this.settings.analysis_model,
          };
          //hahaha gajelas manual lah wireshark minta tolong
          if (
            this.settings.openai_api_key &&
            !this.settings.openai_api_key.includes("•")
          ) {
            // NOT MASKED> XDXD ./.
            settingsData.openai_api_key = this.settings.openai_api_key;
          } else if (this.settings.openai_api_key_unmasked) {
            // Use the unmasked key we stored
            settingsData.openai_api_key = this.settings.openai_api_key_unmasked;
          }

          // Only include depression_aspects if it has valid data (not empty or all empty fields)
          const validAspects = this.settings.depression_aspects.filter(
            (aspect) =>
              aspect.name &&
              aspect.name.trim() &&
              aspect.description &&
              aspect.description.trim()
          );

          if (validAspects.length > 0) {
            settingsData.depression_aspects = validAspects;
          }
          // If no valid aspects, don't include the field at all (null handling)
          
          // Include analysis_scale
          if (this.settings.analysis_scale && this.settings.analysis_scale.length > 0) {
            settingsData.analysis_scale = this.settings.analysis_scale;
          }

          const result = await apiCall(
            "/admin/llm/settings",
            "POST",
            settingsData
          );

          if (result.status === "SNAFU") {
            this.showModal = true;
            this.modalTitle = "Error";
            this.modalMessage =
              "Error saving settings: " +
              (result.error || result.errorMsg || "Unknown error");
            this.modalConfirm = () => {
              this.showModal = false;
            };
            return;
          }

          this.showModal = true;
          this.modalTitle = "Berhasil";
          this.modalMessage = "Pengaturan LLM berhasil disimpan!";
          this.modalConfirm = () => {
            this.showModal = false;
            window.location.reload();
          };
        } catch (error) {
          this.showModal = true;
          this.modalTitle = "Error";
          this.modalMessage = "Error saving data: " + error.message;
          this.modalConfirm = () => {};
        } finally {
          this.loading = false;
        }
      },

      addAspect() {
        this.settings.depression_aspects.push({ name: "", description: "" });
      },

      removeAspect(index) {
        this.settings.depression_aspects.splice(index, 1);
      },

      updateAspectName(index, value) {
        this.settings.depression_aspects[index].name = value;
      },

      updateAspectDescription(index, value) {
        this.settings.depression_aspects[index].description = value;
      },

      async testModel(modelId, type) {
        // The test Model refreh model should load api key from the backend i think its better taht way.. xd,,
        try {
          const result = await apiCall(
            `/admin/llm/models/${encodeURIComponent(modelId)}/test`
          );
          alert(
            `${type} model "${modelId}": ${
              result.available ? "✅ Available" : "❌ Not Available"
            }`
          );
          return result.available || false;
        } catch (error) {
          alert(`Error testing ${type} model "${modelId}": ${error.message}`);
          return false;
        }
      },

      async refreshModels() {
        try {
          const models = await apiCall("/admin/llm/models");
          this.availableModels = Array.isArray(models) ? models : [];
          alert("Model list refreshed!");
        } catch (error) {
          this.availableModels = [];
          alert("Error refreshing models: " + error.message);
        }
      },

      async testApiKey() {
        try {
          // Test either the provided API key or the stored one
          const testData = {};

          // If there's a provided API key that's not masked, use it
          if (
            this.settings.openai_api_key &&
            !this.settings.openai_api_key.includes("•")
          ) {
            testData.api_key = this.settings.openai_api_key;
          }

          // Test API key (either provided or stored)
          const result = await apiCall(
            "/admin/llm/api-key/test",
            "POST",
            testData
          );

          if (result.valid) {
            alert("✅ API Key is valid!");
            this.availableModels = result.models || [];
          } else {
            alert("❌ Invalid API Key: " + (result.error || "Unknown error"));
          }
        } catch (error) {
          alert("Error testing API key: " + error.message);
        }
      },

      copyModelToChat(modelId) {
        this.settings.chat_model = modelId;
      },

      copyModelToAnalysis(modelId) {
        this.settings.analysis_model = modelId;
      },

      // Analysis Scale Methods (PHQ Style)

      updateAnalysisScaleRange() {
        const targetLength = parseInt(this.analysisScaleMax);
        const currentLength = this.settings.analysis_scale.length;
        
        if (targetLength > currentLength) {
          // Add new scales
          for (let i = currentLength; i < targetLength; i++) {
            this.settings.analysis_scale.push({
              value: i,
              description: `Deskripsi untuk skor ${i}`
            });
          }
        } else if (targetLength < currentLength) {
          // Remove excess scales
          this.settings.analysis_scale = this.settings.analysis_scale.slice(0, targetLength);
        }
      },

      updateScaleDescription(index, description) {
        this.settings.analysis_scale[index].description = description;
      },

      previewAnalysisPrompt() {
        // Preview the analysis prompt that would be generated
        fetch('/admin/llm/analysis/preview-prompt', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            sample_conversation: [
              {"role": "assistant", "message": "Hai! Apa kabar?"},
              {"role": "user", "message": "Halo, biasa aja sih."}
            ],
            depression_aspects: this.settings.depression_aspects
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === "OLKORECT") {
            // Show the prompt in a modal or alert
            const prompt = data.data.prompt;
            alert("Analysis Prompt Preview:\n\n" + prompt.substring(0, 1000) + "...");
          } else {
            alert("Error: " + (data.error || "Failed to generate preview"));
          }
        })
        .catch(error => {
          alert("Error generating preview: " + error.message);
        });
      },

      testAnalysis() {
        // Test analysis functionality with sample conversation
        fetch('/admin/llm/analysis/test', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            sample_conversation: [
              {"role": "assistant", "message": "Hai! Apa kabar? Gimana akhir-akhir ini?"},
              {"role": "user", "message": "Hai juga. Hmm, biasa aja sih. Agak capek akhir-akhir ini."},
              {"role": "assistant", "message": "Oh gitu, capek kenapa emangnya? Kerjaan atau gimana?"},
              {"role": "user", "message": "Entah ya, rasanya kayak ga ada yang menarik lagi. Dulu suka banget main game, sekarang udah ga tertarik. Kerja juga kayak robot aja."},
              {"role": "assistant", "message": "Wah, kedengarannya berat ya. Udah berapa lama kamu merasa kayak gitu?"},
              {"role": "user", "message": "Sejak sekitar sebulan yang lalu sih. Awalnya cuma capek biasa aja, tapi makin lama makin males ngerjain apa pun. Bahkan bangun pagi aja rasanya berat."}
            ],
            depression_aspects: this.settings.depression_aspects,
            analysis_scale: this.settings.analysis_scale
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === "OLKORECT") {
            // Show the analysis result
            const result = data.data.analysis;
            let resultText = "Analysis Result:\n\n";
            resultText += "Aspek Depresi yang Teridentifikasi:\n";
            for (const [aspect, score] of Object.entries(result.depression_scores)) {
              const scaleDesc = this.settings.analysis_scale.find(s => s.value === score)?.description || `Skor ${score}`;
              resultText += `- ${aspect}: ${scaleDesc}\n`;
            }
            resultText += "\nTingkat Depresi Keseluruhan: ${result.overall_depression_level}\n";
            resultText += "\nRingkasan: ${result.summary}\n";
            alert(resultText);
          } else {
            alert("Error: " + (data.error || "Failed to generate analysis"));
          }
        })
        .catch(error => {
          alert("Error generating analysis: " + error.message);
        });
      },

      async viewSystemPrompt() {
        try {
          const result = await apiCall('/admin/llm/prompt/build', 'POST', {
            aspects: this.settings.depression_aspects,
            llm_instructions: this.settings.llm_instructions
          });

          if (result.prompt) {
            this.showPreviewModal = true;
            this.previewModalTitle = "System Prompt Preview";
            this.previewModalContent = `
              <h4 style="margin-bottom: 15px; color: #4F46E5; font-size: 16px;">Final System Prompt (dengan Aspects):</h4>
              <pre style="background: #F3F4F6; padding: 20px; border-radius: 8px; white-space: pre-wrap; font-size: 13px; line-height: 1.5; border: 1px solid #D1D5DB;">${result.prompt}</pre>
              <div style="margin-top: 20px; padding: 15px; background: #EEF2FF; border-radius: 8px; font-size: 12px; border: 1px solid #C7D2FE;">
                <strong>ℹ️ Info:</strong> ${this.settings.llm_instructions ? 'Menggunakan Custom Instructions' : 'Menggunakan Default Anisa Prompt'}
              </div>
            `;
          } else {
            alert('Error: ' + (result.error || 'Failed to build prompt'));
          }
        } catch (error) {
          alert('Error building prompt: ' + error.message);
        }
      },
    };
  }
</script>

<!-- Pass LLM data from Jinja to JavaScript -->
<script>
  window.llmData = {{ llm_data | tojson | safe }};
</script>
{% endblock %}
