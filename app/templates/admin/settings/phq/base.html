{% extends "admin/base.html" %} {% block title %}Pengaturan PHQ - Admin{%
endblock %} {% block content %}
<div class="min-h-screen bg-gray-50" x-data="phqSettings()">
  <!-- Header -->
  <div class="bg-white border-b border-gray-200 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">
            Pengaturan PHQ Assessment
          </h1>
          <p class="text-gray-600 mt-1">
            Konfigurasi lengkap untuk penilaian kesehatan mental
          </p>
        </div>
        <div class="flex space-x-3">
          <button
            @click="loadDefaults()"
            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
          >
            Muat Default
          </button>
          <button
            @click="clearAll()"
            class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors"
          >
            Hapus Semua
          </button>
          <button
            @click="saveAll()"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
          >
            Simpan Semua
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-6 py-6 space-y-6">
    {% block phq_content %}{% endblock %}
  </div>

  {% include "components/modal.html" %}

  <!-- Loading -->
  <div
    x-show="loading"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  >
    <div class="bg-white rounded-lg p-8 shadow-xl">
      <div class="text-center">
        <div
          class="animate-spin rounded-full h-12 w-12 border-4 border-gray-200 border-t-blue-600 mx-auto mb-4"
        ></div>
        <p class="text-gray-600 text-lg">Menyimpan data...</p>
      </div>
    </div>
  </div>
</div>

<script>
  function phqSettings() {
    return {
      loading: false,

      config: {
        randomize: "false",
        instructions: "",
      },

      scale: {
        minValue: 1,
        maxValue: 4,
        labels: {
          1: "Label 1",
          2: "Label 2",
          3: "Label 3",
          4: "Label 4",
        },
      },

      categories: [
        {name_id: 'ANHEDONIA', name: 'Anhedonia', description_id: 'Kurang tertarik atau bergairah dalam melakukan apapun', questions: ['']},
        {name_id: 'DEPRESSED_MOOD', name: 'Depressed Mood', description_id: 'Merasa murung, muram, atau putus asa', questions: ['']},
        {name_id: 'SLEEP_DISTURBANCE', name: 'Sleep Disturbance', description_id: 'Sulit tidur atau mudah terbangun, atau terlalu banyak tidur', questions: ['']},
        {name_id: 'FATIGUE', name: 'Fatigue', description_id: 'Merasa lelah atau kurang bertenaga', questions: ['']},
        {name_id: 'APPETITE_CHANGES', name: 'Appetite Changes', description_id: 'Kurang nafsu makan atau terlalu banyak makan', questions: ['']},
        {name_id: 'WORTHLESSNESS', name: 'Worthlessness', description_id: 'Kurang percaya diri — atau merasa bahwa Anda adalah orang yang gagal atau telah mengecewakan diri sendiri atau keluarga', questions: ['']},
        {name_id: 'CONCENTRATION', name: 'Concentration', description_id: 'Sulit berkonsentrasi pada sesuatu, misalnya membaca koran atau menonton televisi', questions: ['']},
        {name_id: 'PSYCHOMOTOR', name: 'Psychomotor', description_id: 'Bergerak atau berbicara sangat lambat sehingga orang lain memperhatikannya. Atau sebaliknya — merasa resah atau gelisah sehingga Anda lebih sering bergerak dari biasanya', questions: ['']},
        {name_id: 'SUICIDAL_IDEATION', name: 'Suicidal Ideation', description_id: 'Merasa lebih baik mati atau ingin melukai diri sendiri dengan cara apapun', questions: ['']}      
      ],

      // Modal state
      showModal: false,
      modalTitle: "",
      modalMessage: "",
      modalConfirm: () => {},

      async init() {
        this.updateScale();
        this.loadDataFromTemplate();
      },

      updateScale() {
        this.scale.minValue = 1; // Always start from 1
        const max = parseInt(this.scale.maxValue);
        const newLabels = {};

        for (let i = 1; i <= max; i++) {
          newLabels[i] = this.scale.labels[i] || `Label ${i}`;
        }

        this.scale.labels = newLabels;
      },



      addQuestion(categoryIndex) {
        this.categories[categoryIndex].questions.push("");
      },

      removeQuestion(categoryIndex, questionIndex) {
        this.categories[categoryIndex].questions.splice(questionIndex, 1);
      },

      loadDefaults() {
        this.showModal = true;
        this.modalTitle = "Muat Data Default";
        this.modalMessage =
          "Apakah Anda yakin ingin memuat data default PHQ-9? Data yang ada akan diganti.";
        this.modalConfirm = () => {
          this.scale = {
            minValue: 1,
            maxValue: 4,
            labels: {
              1: "Tidak sama sekali",
              2: "Beberapa hari",
              3: "Lebih dari setengah hari",
              4: "Hampir setiap hari",
            },
          };
          // Reset to default questions for each category
          this.categories.forEach(cat => {
            cat.questions = [cat.description_id];
          });
        };
      },

      async clearAll() {
        this.showModal = true;
        this.modalTitle = "Hapus Semua Data";
        this.modalMessage =
          "Apakah Anda yakin ingin menghapus semua data PHQ yang ada?";
        this.modalConfirm = async () => {
          this.loading = true;
          try {
            // Get and delete all existing data
            const [categories, scales, settings] = await Promise.all([
              apiCall("/admin/phq/categories"),
              apiCall("/admin/phq/scales"),
              apiCall("/admin/phq/settings"),
            ]);

            // Delete categories (this will cascade delete questions)
            if (Array.isArray(categories)) {
              for (const cat of categories) {
                await apiCall(`/admin/phq/categories/${cat.id}`, "DELETE");
              }
            }

            // Delete scales
            if (Array.isArray(scales)) {
              for (const scale of scales) {
                await apiCall(`/admin/phq/scales/${scale.id}`, "DELETE");
              }
            }

            // Delete settings
            if (Array.isArray(settings)) {
              for (const setting of settings) {
                await apiCall(`/admin/phq/settings/${setting.id}`, "DELETE");
              }
            }

            this.showModal = true;
            this.modalTitle = 'Berhasil';
            this.modalMessage = 'Semua data PHQ berhasil dihapus!';
            this.modalConfirm = () => {};
          } catch (error) {
            this.showModal = true;
            this.modalTitle = 'Error';
            this.modalMessage = 'Error clearing data: ' + error.message;
            this.modalConfirm = () => {};
          } finally {
            this.loading = false;
          }
        };
      },

      loadDataFromTemplate() {
        // Load data from Jinja template context (passed via window.phqData)
        const phqData = window.phqData || {};
        
        try {
          // Load questions for predefined categories
          if (phqData.questions_by_category) {
            for (const category of this.categories) {
              const questions = phqData.questions_by_category[category.name_id] || [];
              category.questions = questions.length > 0 ? questions : [category.description_id];
            }
          }

          // Load scale
          if (phqData.scale) {
            this.scale = {
              id: phqData.scale.id,
              minValue: phqData.scale.min_value,
              maxValue: phqData.scale.max_value,
              labels: phqData.scale.scale_labels,
            };
          }

          // Load settings
          if (phqData.settings) {
            this.config.randomize = phqData.settings.randomize_categories ? "true" : "false";
            this.config.instructions = phqData.settings.instructions || "";
          }
        } catch (error) {
          console.error("Error loading data from template:", error);
        }
      },

      // Keep the old async loadData method for fallback
      async loadData() {
        this.loading = true;
        try {
          // Load all PHQ data
          const [categoriesRes, scalesRes, settingsRes] = await Promise.all([
            apiCall("/admin/phq/categories"),
            apiCall("/admin/phq/scales"),
            apiCall("/admin/phq/settings"),
          ]);

          // Load questions for predefined categories
          if (Array.isArray(categoriesRes) && categoriesRes.length > 0) {
            for (const cat of categoriesRes) {
              // Find matching predefined category
              const predefinedCat = this.categories.find(c => c.name_id === cat.name_id);
              if (predefinedCat) {
                // Load questions for this category
                const questionsRes = await apiCall(
                  `/admin/phq/questions?category_name_id=${cat.name_id}`
                );
                const questions = Array.isArray(questionsRes)
                  ? questionsRes.map((q) => q.question_text_id)
                  : [predefinedCat.description_id];
                
                predefinedCat.questions = questions.length > 0 ? questions : [predefinedCat.description_id];
              }
            }
          }

          // Load scale (find default or first active scale)
          if (Array.isArray(scalesRes) && scalesRes.length > 0) {
            const scale = scalesRes.find(s => s.is_default) || scalesRes[0];
            this.scale = {
              id: scale.id,
              minValue: scale.min_value,
              maxValue: scale.max_value,
              labels: scale.scale_labels,
            };
          }

          // Load settings (find default or first active setting)
          if (Array.isArray(settingsRes) && settingsRes.length > 0) {
            const settings = settingsRes.find(s => s.is_default) || settingsRes[0];
            this.config.randomize = settings.randomize_categories
              ? "true"
              : "false";
            this.config.instructions = settings.instructions || "";
          }
        } catch (error) {
          console.error("Error loading data:", error);
        } finally {
          this.loading = false;
        }
      },

      async saveAll() {
        this.loading = true;
        try {
          // Save scale
          const scaleData = {
            scale_name: "PHQ-9 Default",
            min_value: parseInt(this.scale.minValue),
            max_value: parseInt(this.scale.maxValue),
            scale_labels: this.scale.labels,
            is_default: true,
          };

          console.log("Saving scale:", scaleData);
          const scaleResult = await apiCall(
            "/admin/phq/scales",
            "POST",
            scaleData
          );
          console.log("Scale result:", scaleResult);

          if (scaleResult.status === "SNAFU") {
            alert(
              "Error saving scale: " +
                (scaleResult.error || scaleResult.errorMsg || "Unknown error")
            );
            return;
          }

          // Save questions for each category
          for (let i = 0; i < this.categories.length; i++) {
            const category = this.categories[i];
            
            if (category.questions.length > 0) {
              // Delete existing questions for this category first
              const existingQuestions = await apiCall(
                `/admin/phq/questions?category_name_id=${category.name_id}`
              );
              if (Array.isArray(existingQuestions)) {
                for (const existingQ of existingQuestions) {
                  await apiCall(
                    `/admin/phq/questions/${existingQ.id}`,
                    "DELETE"
                  );
                }
              }

              // Save new questions
              for (let j = 0; j < category.questions.length; j++) {
                if (category.questions[j].trim()) {
                  const questionData = {
                    category_name_id: category.name_id,
                    question_text_en: category.questions[j],
                    question_text_id: category.questions[j],
                    order_index: j,
                  };

                  console.log("Saving question:", questionData);
                  const qResult = await apiCall(
                    "/admin/phq/questions",
                    "POST",
                    questionData
                  );
                  console.log("Question result:", qResult);

                  if (qResult.status === "SNAFU") {
                    alert(
                      "Error saving question: " +
                        (qResult.error || qResult.errorMsg || "Unknown error")
                    );
                    return;
                  }
                }
              }
            }
          }

          // Save settings
          if (scaleResult.status === "OLKORECT") {
            const settingsData = {
              setting_name: "PHQ-9 Default",
              questions_per_category: 1,
              scale_id: scaleResult.data ? scaleResult.data.id : scaleResult.id,
              randomize_questions: this.config.randomize === "true",
              instructions: this.config.instructions,
              is_default: true,
            };

            console.log("Saving settings:", settingsData);
            const settingsResult = await apiCall(
              "/admin/phq/settings",
              "POST",
              settingsData
            );
            console.log("Settings result:", settingsResult);

            if (settingsResult.status === "SNAFU") {
              alert(
                "Error saving settings: " +
                  (settingsResult.error ||
                    settingsResult.errorMsg ||
                    "Unknown error")
              );
              return;
            }
          }

          this.showModal = true;
          this.modalTitle = 'Berhasil';
          this.modalMessage = 'Semua pengaturan PHQ berhasil disimpan!';
          this.modalConfirm = () => {
            window.location.reload();
          };
        } catch (error) {
          console.error("Save error:", error);
          this.showModal = true;
          this.modalTitle = 'Error';
          this.modalMessage = 'Error saving data: ' + error.message;
          this.modalConfirm = () => {};
        } finally {
          this.loading = false;
        }
      },
    };
  }
</script>

<!-- Pass PHQ data from Jinja to JavaScript -->
<script>
  window.phqData = {{ phq_data | tojson | safe }};
</script>
{% endblock %}
